<!DOCTYPE html>
<html lang="en">

<head>
	<title>Authentication in Next.js using Strapi and NextAuth</title>

	<link rel="icon" type="image/x-icon" href="https://nirmalyaghosh.com/images/common/favicon.svg">

	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="title" content="Authentication in Next.js using Strapi and NextAuth">
	<meta name="description" content="Learn how to build an authentication system in a Next.js application with Strapi and NextAuth.">
	<meta name="keywords" content="engineering, software, code">
	<meta name="robots" content="index, follow">
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta name="language" content="English">
	<meta name="author" content="Nirmalya Ghosh">

	<meta property="og:type" content="website">
	<meta property="og:url" content="https://www.nirmalyaghosh.com">
	<meta property="og:title" content="Authentication in Next.js using Strapi and NextAuth">
	<meta property="og:description" content="Learn how to build an authentication system in a Next.js application with Strapi and NextAuth.">
	<meta property="og:image" content="https://nirmalyaghosh.com/images/common/seo-cover.png">

	<meta property="twitter:card" content="summary_large_image">
	<meta property="twitter:url" content="https://www.nirmalyaghosh.com">
	<meta property="twitter:title" content="Nirmalya Ghosh">
	<meta property="twitter:description" content="Learn how to build an authentication system in a Next.js application with Strapi and NextAuth.">
	<meta property="twitter:image" content="https://nirmalyaghosh.com/images/common/seo-cover.png">
<link rel="stylesheet" href="/assets/523a4829.4a78f79c.css" /><script>!(function(w,p,f,c){c=w[p]=Object.assign(w[p]||{},{"lib":"/~partytown/","debug":false});c[f]=(c[f]||[])})(window,'partytown','forward');/* Partytown 0.4.5 - MIT builder.io */
!function(t,e,n,i,r,o,a,d,s,c,p,l){function u(){l||(l=1,"/"==(a=(o.lib||"/~partytown/")+(o.debug?"debug/":""))[0]&&(s=e.querySelectorAll('script[type="text/partytown"]'),i!=t?i.dispatchEvent(new CustomEvent("pt1",{detail:t})):(d=setTimeout(w,1e4),e.addEventListener("pt0",f),r?h(1):n.serviceWorker?n.serviceWorker.register(a+(o.swPath||"partytown-sw.js"),{scope:a}).then((function(t){t.active?h():t.installing&&t.installing.addEventListener("statechange",(function(t){"activated"==t.target.state&&h()}))}),console.error):w())))}function h(t){c=e.createElement(t?"script":"iframe"),t||(c.setAttribute("style","display:block;width:0;height:0;border:0;visibility:hidden"),c.setAttribute("aria-hidden",!0)),c.src=a+"partytown-"+(t?"atomics.js?v=0.4.5":"sandbox-sw.html?"+Date.now()),e.body.appendChild(c)}function w(t,n){for(f(),t=0;t<s.length;t++)(n=e.createElement("script")).innerHTML=s[t].innerHTML,e.head.appendChild(n);c&&c.parentNode.removeChild(c)}function f(){clearTimeout(d)}o=t.partytown||{},i==t&&(o.forward||[]).map((function(e){p=t,e.split(".").map((function(e,n,i){p=p[i[n]]=n+1<i.length?"push"==i[n+1]?[]:p[i[n]]||{}:function(){(t._ptf=t._ptf||[]).push(i,arguments)}}))})),"complete"==e.readyState?u():(t.addEventListener("DOMContentLoaded",u),t.addEventListener("load",u))}(window,document,navigator,top,window.crossOriginIsolated);</script></head>

<body class=" space-y-8">
	<nav class="p-4 max-w-2xl mx-auto w-full flex justify-between items-center">
  <div class="space-x-4">
    <a href="/" class="py-2 px-4 bg-black text-white text-sm no-underline rounded">/</a>
    <a href="/projects" class="text-sm text-black">/projects</a>
    <a href="/articles" class="text-sm text-black">/articles</a>
  </div>
  <div>
    <a href="https://twitter.com/NirmalyaGhosh_" target="_blank" class="py-2 px-4 bg-black text-white text-sm no-underline rounded">Follow</a>
  </div>
</nav>
	<article class="p-4 max-w-2xl mx-auto prose prose-a:text-blue-600 hover:prose-a:text-blue-500 prose-a:no-underline prose-img:rounded-md prose-pre:border prose-pre:text-sm prose-pre:leading-6 prose-code:font-normal">
		<h1>Authentication in Next.js using Strapi and NextAuth</h1>
		<h2>Learn how to build an authentication system in a Next.js application with Strapi and NextAuth.</h2>

		<p>In this tutorial, we'll learn how we can build an authentication system in a
Next.js application using Strapi and NextAuth</p><h2 id="introduction">Introduction</h2><p><a href="https://strapi.io/" target="_blank" rel="nofollow noopener noreferrer">Strapi</a> is the leading open-source headless CMS. Itâ€™s 100% Javascript, fully customizable and developer-first. I've been using Strapi for some of my <a href="https://github.com/ghoshnirmalya" target="_blank" rel="nofollow noopener noreferrer">Open Source projects</a> and the developer experience is really good. It has helped me build prototypes and products much faster.</p><p>I've created a <a href="https://github.com/ghoshnirmalya/nextjs-strapi-boilerplate" target="_blank" rel="nofollow noopener noreferrer">boilerplate</a> so that you can get up and running with <a href="http://strapi.io/" target="_blank" rel="nofollow noopener noreferrer">Strapi</a>, <a href="https://nextjs.org/" target="_blank" rel="nofollow noopener noreferrer">Next.js</a> and <a href="https://www.apollographql.com/" target="_blank" rel="nofollow noopener noreferrer">Apollo</a> quickly. Check out the project on <a href="https://github.com/ghoshnirmalya/nextjs-strapi-boilerplate" target="_blank" rel="nofollow noopener noreferrer">Github</a>.</p><a href="https://github.com/ghoshnirmalya/nextjs-strapi-boilerplate" target="_blank"><img src="https://user-images.githubusercontent.com/6391763/90599044-ca070300-e211-11ea-8b8a-89354dd30bd5.png" alt="Logo"></a><p><a href="https://next-auth.js.org/" target="_blank" rel="nofollow noopener noreferrer">NextAuth</a> is a library for building authentication in a <a href="https://nextjs.org/" target="_blank" rel="nofollow noopener noreferrer">Next.js</a> application. It's flexible, secure and easy to use.</p><p>The application that we'll be building is hosted on <a href="https://nextjs-strapi-boilerplate.vercel.app/" target="_blank" rel="nofollow noopener noreferrer">Vercel</a> and the code is available on <a href="https://github.com/ghoshnirmalya/nextjs-strapi-boilerplate" target="_blank" rel="nofollow noopener noreferrer">Github</a>.</p><h2 id="pre-requisites">Pre-requisites</h2><ol>
<li><a href="https://nodejs.org/" target="_blank" rel="nofollow noopener noreferrer">Node.js</a></li>
<li><a href="https://www.npmjs.com/" target="_blank" rel="nofollow noopener noreferrer">npm</a></li>
<li><a href="https://www.docker.com/" target="_blank" rel="nofollow noopener noreferrer">Docker</a></li>
</ol><h2 id="cloning-our-repository">Cloning our repository</h2><p>Let's get started by cloning the repository that we'll be working on. We can clone our repository using the following command:</p><pre class="astro-code" style="background-color: #22272e; overflow-x: auto;"><code><span class="line"><span style="color: #ADBAC7">git clone https://github.com/ghoshnirmalya/nextjs-strapi-boilerplate</span></span></code></pre><h2 id="installing-dependencies-for-the-nextjs-application">Installing dependencies for the Next.js application</h2><p>We can install all the necessary dependencies by running the following command:</p><pre class="astro-code" style="background-color: #22272e; overflow-x: auto;"><code><span class="line"><span style="color: #6CB6FF">cd</span><span style="color: #ADBAC7"> frontend </span><span style="color: #F47067">&amp;&amp;</span><span style="color: #ADBAC7"> yarn install</span></span></code></pre><h2 id="copying-the-environment-variables">Copying the environment variables</h2><p>We can create a .env file and copy the contents from .env.example which is present in the frontend directory. The following credentials are necessary for authentication:</p><pre class="astro-code" style="background-color: #22272e; overflow-x: auto;"><code><span class="line"><span style="color: #96D0FF">NEXT_PUBLIC_API_URL=http://localhost:1337</span></span>
<span class="line"><span style="color: #96D0FF">NEXT_PUBLIC_DATABASE_URL=postgres://strapi:strapi@localhost:5432/strapi?synchronize=true</span></span>
<span class="line"><span style="color: #96D0FF">NEXTAUTH_URL=http://localhost:3000</span></span>
<span class="line"><span style="color: #96D0FF">GOOGLE_CLIENT_ID=&quot;&quot;</span></span>
<span class="line"><span style="color: #96D0FF">GOOGLE_CLIENT_SECRET=&quot;&quot;</span></span></code></pre><h2 id="creating-and-copying-the-google-client-credentials">Creating and copying the Google client credentials</h2><p>We can create a new <a href="https://console.developers.google.com/apis/credentials/oauthclient" target="_blank" rel="nofollow noopener noreferrer">Google OAuth Client</a> and copy the credentials (Client ID and Client Secret) in your .env file.</p><ol>
<li>Create a new <strong>OAuth client ID</strong>.</li>
<li>Choose <strong>Web application</strong> as the <strong>Application Type</strong>.</li>
<li>Add the following <strong>Authorized redirect URIs</strong>:</li>
</ol><pre class="astro-code" style="background-color: #22272e; overflow-x: auto;"><code><span class="line"><span style="color: #96D0FF">http://localhost:3000/api/auth/callback/google</span></span>
<span class="line"><span style="color: #96D0FF">http://localhost:1337/connect/google/callback</span></span></code></pre><p><img src="/images/content/authentication-in-next-js-with-strapi-and-next-auth/1.png" alt="Authorized redirect URIs" width="998" height="435" loading="lazy"></p><h2 id="starting-the-frontend-application">Starting the frontend application</h2><p>From the frontend directory, we can run the following command to start our Next.js application:</p><pre class="astro-code" style="background-color: #22272e; overflow-x: auto;"><code><span class="line"><span style="color: #ADBAC7">yarn dev</span></span></code></pre><h2 id="starting-our-strapi-application">Starting our Strapi application</h2><p>We can go inside the directory of the backend package on another terminal window and start docker compose:</p><pre class="astro-code" style="background-color: #22272e; overflow-x: auto;"><code><span class="line"><span style="color: #6CB6FF">cd</span><span style="color: #ADBAC7"> backend </span><span style="color: #F47067">&amp;&amp;</span><span style="color: #ADBAC7"> docker-compose up</span></span></code></pre><blockquote>
<p>We need to start Docker and then run the above command which will change the current directory to the backend packageâ€™s directory and then start the backend package. If everything goes well, itâ€™ll be up and running on <a href="http://localhost:1337/graphql" target="_blank" rel="nofollow noopener noreferrer">http://localhost:1337/graphql</a>.</p>
</blockquote><h2 id="configuring-the-google-provider-in-the-strapi-admin-panel">Configuring the Google provider in the Strapi admin panel</h2><p>In the Strapi admin panel, we need to add the Google OAuth Client credentials and enable the <strong>Google provider</strong>.</p><p><img src="/images/content/authentication-in-next-js-with-strapi-and-next-auth/2.png" alt="Google provider configuration in the Strapi admin panel" width="3418" height="1894" loading="lazy"></p><h2 id="configuring-nextauth-with-our-nextjs-application">Configuring NextAuth with our Next.js application</h2><p>All the configurations related to NextAuth is present on the <a href="https://github.com/ghoshnirmalya/nextjs-strapi-boilerplate/blob/master/frontend/pages/api/auth/%5B...nextauth%5D.ts" target="_blank" rel="nofollow noopener noreferrer">[...nextauth.ts]</a> file. We can use the following NextAuth options to use NextAuth with Strapi:</p><pre class="astro-code" style="background-color: #22272e; overflow-x: auto;"><code><span class="line"><span style="color: #F47067">const</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">options</span><span style="color: #ADBAC7"> </span><span style="color: #F47067">=</span><span style="color: #ADBAC7"> {</span></span>
<span class="line"><span style="color: #ADBAC7">  providers: [</span></span>
<span class="line"><span style="color: #ADBAC7">    Providers.</span><span style="color: #DCBDFB">Google</span><span style="color: #ADBAC7">({</span></span>
<span class="line"><span style="color: #ADBAC7">      clientId: process.env.</span><span style="color: #6CB6FF">GOOGLE_CLIENT_ID</span><span style="color: #ADBAC7">,</span></span>
<span class="line"><span style="color: #ADBAC7">      clientSecret: process.env.</span><span style="color: #6CB6FF">GOOGLE_CLIENT_SECRET</span><span style="color: #ADBAC7">,</span></span>
<span class="line"><span style="color: #ADBAC7">    }),</span></span>
<span class="line"><span style="color: #ADBAC7">  ],</span></span>
<span class="line"><span style="color: #ADBAC7">  database: process.env.</span><span style="color: #6CB6FF">NEXT_PUBLIC_DATABASE_URL</span><span style="color: #ADBAC7">,</span></span>
<span class="line"><span style="color: #ADBAC7">  session: {</span></span>
<span class="line"><span style="color: #ADBAC7">    jwt: </span><span style="color: #6CB6FF">true</span><span style="color: #ADBAC7">,</span></span>
<span class="line"><span style="color: #ADBAC7">  },</span></span>
<span class="line"><span style="color: #ADBAC7">  debug: </span><span style="color: #6CB6FF">true</span><span style="color: #ADBAC7">,</span></span>
<span class="line"><span style="color: #ADBAC7">  callbacks: {</span></span>
<span class="line"><span style="color: #ADBAC7">    </span><span style="color: #DCBDFB">session</span><span style="color: #ADBAC7">: </span><span style="color: #F47067">async</span><span style="color: #ADBAC7"> (</span><span style="color: #F69D50">session</span><span style="color: #F47067">:</span><span style="color: #ADBAC7"> </span><span style="color: #F69D50">ISession</span><span style="color: #ADBAC7">, </span><span style="color: #F69D50">user</span><span style="color: #F47067">:</span><span style="color: #ADBAC7"> </span><span style="color: #F69D50">IUser</span><span style="color: #ADBAC7">) </span><span style="color: #F47067">=&gt;</span><span style="color: #ADBAC7"> {</span></span>
<span class="line"><span style="color: #ADBAC7">      session.jwt </span><span style="color: #F47067">=</span><span style="color: #ADBAC7"> user.jwt;</span></span>
<span class="line"><span style="color: #ADBAC7">      session.id </span><span style="color: #F47067">=</span><span style="color: #ADBAC7"> user.id;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ADBAC7">      </span><span style="color: #F47067">return</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">Promise</span><span style="color: #ADBAC7">.</span><span style="color: #DCBDFB">resolve</span><span style="color: #ADBAC7">(session);</span></span>
<span class="line"><span style="color: #ADBAC7">    },</span></span>
<span class="line"><span style="color: #ADBAC7">    </span><span style="color: #DCBDFB">jwt</span><span style="color: #ADBAC7">: </span><span style="color: #F47067">async</span><span style="color: #ADBAC7"> (</span><span style="color: #F69D50">token</span><span style="color: #F47067">:</span><span style="color: #ADBAC7"> </span><span style="color: #F69D50">iToken</span><span style="color: #ADBAC7">, </span><span style="color: #F69D50">user</span><span style="color: #F47067">:</span><span style="color: #ADBAC7"> </span><span style="color: #F69D50">IUser</span><span style="color: #ADBAC7">, </span><span style="color: #F69D50">account</span><span style="color: #F47067">:</span><span style="color: #ADBAC7"> </span><span style="color: #F69D50">IAccount</span><span style="color: #ADBAC7">) </span><span style="color: #F47067">=&gt;</span><span style="color: #ADBAC7"> {</span></span>
<span class="line"><span style="color: #ADBAC7">      </span><span style="color: #F47067">const</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">isSignIn</span><span style="color: #ADBAC7"> </span><span style="color: #F47067">=</span><span style="color: #ADBAC7"> user </span><span style="color: #F47067">?</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">true</span><span style="color: #ADBAC7"> </span><span style="color: #F47067">:</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">false</span><span style="color: #ADBAC7">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ADBAC7">      </span><span style="color: #F47067">if</span><span style="color: #ADBAC7"> (isSignIn) {</span></span>
<span class="line"><span style="color: #ADBAC7">        </span><span style="color: #F47067">const</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">response</span><span style="color: #ADBAC7"> </span><span style="color: #F47067">=</span><span style="color: #ADBAC7"> </span><span style="color: #F47067">await</span><span style="color: #ADBAC7"> </span><span style="color: #DCBDFB">fetch</span><span style="color: #ADBAC7">(</span></span>
<span class="line"><span style="color: #ADBAC7">          </span><span style="color: #96D0FF">`${</span><span style="color: #ADBAC7">process</span><span style="color: #96D0FF">.</span><span style="color: #ADBAC7">env</span><span style="color: #96D0FF">.</span><span style="color: #6CB6FF">NEXT_PUBLIC_API_URL</span><span style="color: #96D0FF">}/auth/${</span><span style="color: #ADBAC7">account</span><span style="color: #96D0FF">.</span><span style="color: #ADBAC7">provider</span><span style="color: #96D0FF">}/callback?access_token=${</span><span style="color: #ADBAC7">account</span><span style="color: #96D0FF">?.</span><span style="color: #ADBAC7">accessToken</span><span style="color: #96D0FF">}`</span></span>
<span class="line"><span style="color: #ADBAC7">        );</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ADBAC7">        </span><span style="color: #F47067">const</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">data</span><span style="color: #ADBAC7"> </span><span style="color: #F47067">=</span><span style="color: #ADBAC7"> </span><span style="color: #F47067">await</span><span style="color: #ADBAC7"> response.</span><span style="color: #DCBDFB">json</span><span style="color: #ADBAC7">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ADBAC7">        token.jwt </span><span style="color: #F47067">=</span><span style="color: #ADBAC7"> data.jwt;</span></span>
<span class="line"><span style="color: #ADBAC7">        token.id </span><span style="color: #F47067">=</span><span style="color: #ADBAC7"> data.user.id;</span></span>
<span class="line"><span style="color: #ADBAC7">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ADBAC7">      </span><span style="color: #F47067">return</span><span style="color: #ADBAC7"> </span><span style="color: #6CB6FF">Promise</span><span style="color: #ADBAC7">.</span><span style="color: #DCBDFB">resolve</span><span style="color: #ADBAC7">(token);</span></span>
<span class="line"><span style="color: #ADBAC7">    },</span></span>
<span class="line"><span style="color: #ADBAC7">  },</span></span>
<span class="line"><span style="color: #ADBAC7">};</span></span></code></pre><p>In the <a href="https://next-auth.js.org/configuration/options#callbacks" target="_blank" rel="nofollow noopener noreferrer">NextAuth callback</a> function, we're calling the <a href="https://strapi.io/documentation/v3.x/plugins/users-permissions.html#authentication" target="_blank" rel="nofollow noopener noreferrer">Strapi Authentication</a> API endpoint. We're storing the <code>JWT</code> and <code>user.id</code> from data that the Strapi API sends us. In this way, we can understand which user is currently authenticated.</p><h2 id="getting-session-details-for-authenticated-users">Getting session details for authenticated users</h2><p>We can get the details of the authenticated users from the <a href="https://next-auth.js.org/getting-started/client#getsession" target="_blank" rel="nofollow noopener noreferrer"><code>getSession</code></a> function of NextAuth. If the <code>getSession</code> function doesn't return us any details, then we can assume that the user is <a href="https://github.com/ghoshnirmalya/nextjs-strapi-boilerplate/blob/master/frontend/pages/feeds.tsx#L12-L14" target="_blank" rel="nofollow noopener noreferrer">not authenticated</a>.</p><h2 id="conclusion">Conclusion</h2><p>In this tutorial, we understood how we can implement authentication in a Next.js application using Strapi and NextAuth. I've created a <a href="https://github.com/ghoshnirmalya/nextjs-strapi-boilerplate" target="_blank" rel="nofollow noopener noreferrer">boilerplate</a> so that you can get up and running with Strapi, Next.js and Apollo quickly. Check out the project on <a href="https://github.com/ghoshnirmalya/nextjs-strapi-boilerplate" target="_blank" rel="nofollow noopener noreferrer">Github</a>. Documentation of this project is available <a href="/guides/nextjs-strapi-boilerplate">here</a>.</p><a href="https://github.com/ghoshnirmalya/nextjs-strapi-boilerplate" target="_blank"><img src="https://user-images.githubusercontent.com/6391763/90599044-ca070300-e211-11ea-8b8a-89354dd30bd5.png" alt="Logo"></a>

	</article>
</body></html>